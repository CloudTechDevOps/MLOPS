name: Deploy Flask ML App with Health Check (with Rollback)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2, Health Check, and Rollback on Failure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Backup existing app on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "
            if [ -d ~/mlapp ]; then
              echo 'ðŸ“¦ Backing up current app to ~/mlapp-backup'
              rm -rf ~/mlapp-backup
              cp -r ~/mlapp ~/mlapp-backup
            else
              echo 'â„¹ï¸ No existing app to backup'
            fi
          "

      - name: Copy new app files to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} "mkdir -p ~/mlapp"
          scp -o StrictHostKeyChecking=no -r app/* ec2-user@${{ secrets.EC2_HOST }}:~/mlapp/

      - name: Install Python & pip on EC2
        run: |
          ssh -tt ec2-user@${{ secrets.EC2_HOST }} "
            sudo yum install -y python3 &&
            python3 -m ensurepip --upgrade &&
            pip3 install --upgrade pip setuptools
          "

      - name: Install Python dependencies
        run: |
          ssh -tt ec2-user@${{ secrets.EC2_HOST }} "
            cd ~/mlapp &&
            pip3 install -r requirements.txt
          "

      - name: Stop and Start Flask App
        run: |
          ssh -tt ec2-user@${{ secrets.EC2_HOST }} "
            echo 'ðŸ›‘ Killing any process on port 5000...'
            PID=\$(lsof -t -i:5000) && kill -9 \$PID || echo 'Nothing running on port 5000.'

            echo 'ðŸš€ Starting new Flask app...'
            cd ~/mlapp
            nohup python3 app.py > output.log 2>&1 < /dev/null & disown
            sleep 5

            echo 'ðŸ“„ Checking logs...'
            if [ -f ~/mlapp/output.log ]; then
              tail -n 20 ~/mlapp/output.log
            else
              echo 'âŒ output.log not found - app may have crashed.'
            fi
          "

      - name: Wait for App to Start
        run: sleep 10

      - name: Run Health Check
        run: |
          echo "ðŸ”Ž Running health check..."
          curl --fail http://${{ secrets.EC2_HOST }}:5000/health

      - name: Notify on Success
        if: success()
        run: echo "âœ… Deployment succeeded and health check passed."

      - name: Rollback to previous version (on failure)
        if: failure()
        run: |
          ssh -tt ec2-user@${{ secrets.EC2_HOST }} "
            echo 'âš ï¸ Health check failed. Rolling back to last known good version...'
            if [ -d ~/mlapp-backup ]; then
              rm -rf ~/mlapp
              mv ~/mlapp-backup ~/mlapp
              PID=\$(lsof -t -i:5000) && kill -9 \$PID || echo 'Nothing running on port 5000'
              cd ~/mlapp
              nohup python3 app.py > output.log 2>&1 < /dev/null & disown
              sleep 5
              echo 'ðŸ” Verifying rollback health...'
              curl --fail http://localhost:5000/health \
                && echo 'âœ… Rollback succeeded' \
                || echo 'âŒ Rollback health check failed'
            else
              echo 'âŒ No backup found to rollback. Manual action required.'
            fi
          "
