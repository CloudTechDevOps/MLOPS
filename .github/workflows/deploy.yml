name: Deploy Flask ML App with Health Check

on:
  push:
    branches: [ main ]
  workflow_dispatch:   # Optional: allows manual trigger

jobs:
  deploy:
    name: Deploy to EC2 and Run Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Copy App Files to EC2
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.EC2_HOST }} "mkdir -p ~/mlapp"
          scp -r app/* root@${{ secrets.EC2_HOST }}:~/mlapp/

      - name: Start Flask App on EC2
        run: |
          ssh root@${{ secrets.EC2_HOST }} "
            cd ~/mlapp &&
            pip3 install -r requirements.txt &&
            nohup python3 app.py > output.log 2>&1 &
            sleep 3 &&
            tail -n 20 output.log
          "

      - name: Wait for App to Start
        run: sleep 10

      - name: Run Health Check
        run: |
          curl --fail http://${{ secrets.EC2_HOST }}:5000/health

      - name: Notify on Success
        if: success()
        run: echo "✅ Deployment succeeded and health check passed."

      - name: Auto Rollback Simulation (optional)
        if: failure()
        run: echo "❌ Deployment failed. Please rollback to previous version."
